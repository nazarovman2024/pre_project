<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        .top-bar {
            background-color: #343a40;
            color: white;
            padding: 10px 20px;
        }

        .container-fluid {
            display: flex;
            height: calc(100vh - 48px);
        }

        .nav-panel {
            width: 250px;
            background-color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .nav-link {
            padding: 12px 20px;
            color: #0d6efd;
            text-decoration: none;
            display: block;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-link:hover {
            background-color: rgba(13, 110, 253, 0.1);
        }

        .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-left: 4px solid #0d6efd;
        }

        .content {
            flex: 1;
            background-color: #f8f9fa;
            padding: 20px;
        }

        .tabs {
            display: flex;
            margin-bottom: 0;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 1px;
        }

        .tab {
            padding: 8px 16px;
            text-decoration: none;
            color: #0d6efd;
            margin-right: 15px;
        }

        .tab.active {
            color: #495057;
            background-color: white;
            border: 1px solid #dee2e6;
            border-bottom: 1px solid white;
            border-radius: 4px 4px 0 0;
            position: relative;
            top: 1px;
        }

        .users-container {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
        }

        .users-header {
            background-color: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }

        .users-content {
            padding: 20px;
        }

    </style>
</head>
<body>
<!-- Тёмно-серая верхняя панель -->
<div class="top-bar d-flex justify-content-between align-items-center">
    <!-- Блок текста слева -->
    <div>
      <span>
        <strong th:text="${#authentication.principal.id} + ' # ' + ${#authentication.principal.username}"></strong>
      </span>
        <span th:text="' with roles: '"></span>
        <span th:each="role : ${#authentication.principal.authorities}" class="role-badge"
              th:text="${#strings.replace(role.name,'ROLE_','')} + ' '"></span>
    </div>

    <!-- Ссылка справа -->
    <div>
        <form th:action="@{/logout}" method="post" class="d-inline">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-sign-out-alt me-1"></i> Logout
            </button>
        </form>
    </div>
</div>

<!-- Основной контент -->
<div class="container-fluid">
    <!-- Навигационная панель -->
    <div class="nav-panel">
        <a href="#" class="nav-link active">Admin</a>
        <a href="../../profile" class="nav-link">User</a>
    </div>

    <!-- Основной контент -->
    <div class="content">
        <h2>Admin panel</h2>
        <div class="tabs">
            <a href="#" class="tab active">Users table</a>
            <a th:href="@{/admin/new}" class="tab">New User</a>
        </div>

        <!-- Контейнер для All Users -->
        <div class="users-container">
            <div class="users-header">All users</div>
            <div class="users-content">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Role</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="user, userStat : ${users}"
                        th:classappend="${userStat.odd} ? 'table-light' : 'table-default'">
                        <td th:text="${user.id}"></td>
                        <td th:text="${user.username}"></td>
                        <td>
          <span th:each="role, roleStat : ${user.roles}" class="role-badge">
            <span th:text="${#strings.replace(role.name,'ROLE_','')}"></span>
          </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary edit" data-bs-toggle="modal"
                                    data-bs-target="#editUserModal"
                                    th:attr="data-user-id=${user.id},
                 data-user-username=${user.username},
                 data-user-roles=${user.roles}">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteUserModal"
                                    th:attr="data-user-id=${user.id},
                 data-user-username=${user.username},
                 data-user-roles=${user.roles}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm" th:action="@{/admin/edit}" method="post">
                    <input type="hidden" id="editUserId" name="id">

                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="editPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="editPassword" name="password" required>
                    </div>

                    <div class="mb-3">
                        <label for="editConfirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="editConfirmPassword" name="confirmPassword" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <div class="d-flex flex-wrap">
                            <div th:each="role : ${allRoles}" class="form-check me-3">
                                <input class="form-check-input" type="checkbox"
                                       th:id="${'editRole_' + role.id}"
                                       th:value="${role.id}" name="roles">
                                <label class="form-check-label"
                                       th:for="${'editRole_' + role.id}"
                                       th:text="${#strings.replace(role.authority,'ROLE_','')}"></label>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitEditForm()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Delete user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="deleteUserForm" method="post">
                    <div class="user-details">
                        <label>ID</label>
                        <div id="deleteUserId"></div>
                    </div>

                    <div class="user-details">
                        <label>Username</label>
                        <div id="deleteUsername"></div>
                    </div>

                    <div class="user-details">
                        <label>Roles</label>
                        <div id="deleteUserRoles"></div>
                    </div>

                    <input type="hidden" id="deleteUserCsrf" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                </form>
                <div class="alert alert-warning mt-3">
                    Are you sure you want to delete this user? This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="submitDeleteForm()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Initialize edit modal with user data
    document.getElementById('editUserModal').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const userId = button.getAttribute('data-user-id');
        const username = button.getAttribute('data-user-username');
        const roles = JSON.parse(button.getAttribute('data-user-roles'));

        const modal = this;
        modal.querySelector('#editUserId').value = userId;
        modal.querySelector('#editUsername').value = username;

        // Reset all checkboxes
        modal.querySelectorAll('.form-check-input').forEach(checkbox => {
            checkbox.checked = false;
        });

        // Set checked roles
        roles.forEach(role => {
            const checkbox = modal.querySelector(`input[value="${role.id}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });

        // Clear password fields
        modal.querySelector('#editPassword').value = '';
        modal.querySelector('#editConfirmPassword').value = '';
    });

    function submitEditForm() {
        const form = document.getElementById('editUserForm');
        const password = form.querySelector('#editPassword').value;
        const confirmPassword = form.querySelector('#editConfirmPassword').value;

        if (password !== confirmPassword) {
            alert('Passwords do not match!');
            return;
        }

        form.submit();
    }

    // Initialize delete modal with user data
    document.getElementById('deleteUserModal').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const userId = button.getAttribute('data-user-id');
        const username = button.getAttribute('data-user-username');
        const roles = JSON.parse(button.getAttribute('data-user-roles'));

        const modal = this;
        modal.querySelector('#deleteUserId').textContent = userId;
        modal.querySelector('#deleteUsername').textContent = username;

        // Format roles
        const rolesContainer = modal.querySelector('#deleteUserRoles');
        rolesContainer.innerHTML = '';
        roles.forEach(role => {
            const roleName = role.name.replace('ROLE_', '');
            const badge = document.createElement('span');
            badge.className = 'role-badge';
            badge.textContent = roleName;
            rolesContainer.appendChild(badge);
        });

        // Update form action
        document.getElementById('deleteUserForm').action = `/admin/delete?id=${userId}`;
    });

    function submitDeleteForm() {
        document.getElementById('deleteUserForm').submit();
    }
</script>
</body>
</html>